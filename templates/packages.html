{% extends "base.html" %}

{% block title %}Travel Packages - ExploreEase{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>Travel Packages</h1>
            <p class="text-muted">Discover amazing destinations tailored for your perfect vacation</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="region" class="form-label">Region</label>
                            <select class="form-select" id="region" name="region">
                                <option value="all" {% if region == 'all' %}selected{% endif %}>All Regions</option>
                                <option value="West Bengal" {% if region == 'West Bengal' %}selected{% endif %}>West Bengal</option>
                                <option value="Northeast" {% if region == 'Northeast' %}selected{% endif %}>Northeast India</option>
                                <option value="Other India" {% if region == 'Other India' %}selected{% endif %}>Other India</option>
                                <option value="International" {% if region == 'International' %}selected{% endif %}>International</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="all" {% if category == 'all' %}selected{% endif %}>All Categories</option>
                                <option value="Hill Station" {% if category == 'Hill Station' %}selected{% endif %}>Hill Station</option>
                                <option value="Wildlife" {% if category == 'Wildlife' %}selected{% endif %}>Wildlife</option>
                                <option value="Cultural" {% if category == 'Cultural' %}selected{% endif %}>Cultural</option>
                                <option value="Nature" {% if category == 'Nature' %}selected{% endif %}>Nature</option>
                                <option value="Adventure" {% if category == 'Adventure' %}selected{% endif %}>Adventure</option>
                                <option value="Trekking" {% if category == 'Trekking' %}selected{% endif %}>Trekking</option>
                                <option value="Beach" {% if category == 'Beach' %}selected{% endif %}>Beach</option>
                                <option value="Heritage" {% if category == 'Heritage' %}selected{% endif %}>Heritage</option>
                                <option value="Luxury" {% if category == 'Luxury' %}selected{% endif %}>Luxury</option>
                                <option value="Leisure" {% if category == 'Leisure' %}selected{% endif %}>Leisure</option>
                                <option value="Honeymoon" {% if category == 'Honeymoon' %}selected{% endif %}>Honeymoon</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="name" {% if sort == 'name' %}selected{% endif %}>Name</option>
                                <option value="price_low" {% if sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                                <option value="price_high" {% if sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                                <option value="rating" {% if sort == 'rating' %}selected{% endif %}>Rating</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search }}" placeholder="Search packages...">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <a href="{{ url_for('packages') }}" class="btn btn-outline-secondary">Reset</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Packages Grid -->
    <div class="row">
        {% if packages %}
            {% for package in packages %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 package-card">
                    <img src="{{ url_for('static', filename='images/' + package[10]) }}" class="card-img-top" alt="{{ package[1] }}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title">{{ package[1] }}</h5>
                            <span class="badge bg-primary">{{ package[4] }}</span>
                        </div>
                        <p class="card-text text-muted">{{ package[9][:100] }}...</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-primary">â‚¹{{ "%.2f"|format(package[5]) }}</span>
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-star"></i> {{ package[6] }}
                            </span>
                        </div>
                        <div class="mb-3">
                            <span class="badge bg-secondary">{{ package[3] }}</span>
                            <span class="badge bg-info">{{ package[2] }}</span>
                            <span class="badge bg-dark">{{ package[11] }}</span>
                        </div>
                        <div class="availability">
                            <small class="text-muted">
                                <i class="fas fa-users"></i> {{ package[14] }} slots available
                            </small>
                        </div>
                    </div>
                <!-- Replace the existing card-footer section in packages.html with this: -->
                <div class="card-footer">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('package_detail', package_id=package[0]) }}" class="btn btn-outline-primary">View Details</a>
                        {% if current_user.is_authenticated %}
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('book_package', package_id=package[0]) }}" class="btn btn-primary">Book Now</a>
                            <a href="{{ url_for('add_to_wishlist', package_id=package[0]) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-heart"></i>
                            </a>
                            <!-- ADD COMPARE BUTTON -->
                            <button type="button" class="btn btn-outline-info compare-btn" 
                                    data-package-id="{{ package[0] }}"
                                    title="Add to Compare">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        </div>
                        {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-primary">Login to Book</a>
                        {% endif %}
                    </div>
                </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h3>No packages found</h3>
                    <p class="text-muted">Try adjusting your filters or search terms.</p>
                    <a href="{{ url_for('packages') }}" class="btn btn-primary">Clear Filters</a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Compare Feature -->
    {% if packages %}
<!-- Compare Feature - Replace the existing compare section with this: -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h5><i class="fas fa-balance-scale"></i> Compare Packages</h5>
                    <p class="text-muted">Select up to 3 packages to compare features and prices</p>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="{{ url_for('compare_packages') }}" class="btn btn-outline-primary" id="compareBtn">
                            Compare Selected Packages 
                            <span class="badge bg-danger ms-1" id="compareBadge" style="display: none;">0</span>
                        </a>
                        <button class="btn btn-outline-secondary" onclick="clearComparison()">
                            Clear All
                        </button>
                    </div>
                    <div id="selectedPackages" class="mt-3 small text-muted"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when filters change
    const filters = document.querySelectorAll('#region, #category, #sort');
    filters.forEach(filter => {
        filter.addEventListener('change', function() {
            this.form.submit();
        });
    });

    // Package card animations
    const packageCards = document.querySelectorAll('.package-card');
    packageCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});

// Compare package functionality
let comparePackages = [];

document.addEventListener('DOMContentLoaded', function() {
    // Load compare packages from session storage
    const saved = sessionStorage.getItem('comparePackages');
    if (saved) {
        comparePackages = JSON.parse(saved);
        updateCompareUI();
    }
    
    // Compare button click handler
    document.querySelectorAll('.compare-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const packageId = this.getAttribute('data-package-id');
            const packageName = this.closest('.card').querySelector('.card-title').textContent;
            toggleComparePackage(packageId, packageName, this);
        });
        
        // Update button state on page load
        const packageId = btn.getAttribute('data-package-id');
        if (comparePackages.find(p => p.id === packageId)) {
            updateButtonState(btn, true);
        }
    });
});

function toggleComparePackage(packageId, packageName, button) {
    const existingIndex = comparePackages.findIndex(p => p.id === packageId);
    
    if (existingIndex === -1) {
        // Add to compare
        if (comparePackages.length >= 3) {
            showToast('You can compare up to 3 packages only', 'warning');
            return;
        }
        comparePackages.push({ id: packageId, name: packageName });
        updateButtonState(button, true);
        showToast(`"${packageName}" added to comparison`, 'success');
    } else {
        // Remove from compare
        comparePackages.splice(existingIndex, 1);
        updateButtonState(button, false);
        showToast(`"${packageName}" removed from comparison`, 'info');
    }
    
    sessionStorage.setItem('comparePackages', JSON.stringify(comparePackages));
    updateCompareUI();
}

function updateButtonState(button, isSelected) {
    if (isSelected) {
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-info', 'text-white');
        button.innerHTML = '<i class="fas fa-check"></i>';
    } else {
        button.classList.remove('btn-info', 'text-white');
        button.classList.add('btn-outline-info');
        button.innerHTML = '<i class="fas fa-balance-scale"></i>';
    }
}

function updateCompareUI() {
    const compareBtn = document.getElementById('compareBtn');
    const compareBadge = document.getElementById('compareBadge');
    const selectedPackagesDiv = document.getElementById('selectedPackages');
    
    if (comparePackages.length > 0) {
        // Update compare button
        const packageIds = comparePackages.map(p => p.id).join(',');
        compareBtn.href = `{{ url_for('compare_packages') }}?package_ids=${packageIds}`;
        compareBadge.textContent = comparePackages.length;
        compareBadge.style.display = 'inline';
        
        // Update selected packages list
        selectedPackagesDiv.innerHTML = `<strong>Selected:</strong> ${comparePackages.map(p => p.name).join(', ')}`;
        selectedPackagesDiv.style.display = 'block';
    } else {
        compareBtn.href = '{{ url_for('compare_packages') }}';
        compareBadge.style.display = 'none';
        selectedPackagesDiv.style.display = 'none';
    }
}

function clearComparison() {
    comparePackages = [];
    sessionStorage.removeItem('comparePackages');
    
    // Reset all compare buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        updateButtonState(btn, false);
    });
    
    updateCompareUI();
    showToast('Comparison cleared', 'info');
}

// Toast notification function (add this if not exists)
function showToast(message, type = 'info') {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

</script>
{% endblock %}